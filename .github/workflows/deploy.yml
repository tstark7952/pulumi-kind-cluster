name: Deploy Kubernetes Cluster

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'up'
        type: choice
        options:
          - up
          - destroy
          - preview
      stack:
        description: 'Pulumi stack'
        required: false
        default: 'dev'

jobs:
  deploy:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'

    - name: Install dependencies
      run: |
        brew install lima kind kubectl pulumi

    - name: Setup Pulumi
      uses: pulumi/actions@v5
      with:
        command: ${{ github.event.inputs.action }}
        stack-name: ${{ github.event.inputs.stack }}
      env:
        PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        PULUMI_CONFIG_PASSPHRASE: ${{ secrets.PULUMI_CONFIG_PASSPHRASE }}

    - name: Show deployment info
      if: github.event.inputs.action == 'up'
      run: |
        pulumi stack output
      env:
        PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        PULUMI_CONFIG_PASSPHRASE: ${{ secrets.PULUMI_CONFIG_PASSPHRASE }}
